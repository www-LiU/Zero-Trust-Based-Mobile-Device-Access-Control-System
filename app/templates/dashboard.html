{% extends "base.html" %}
{% block content %}

<!-- é¡¶éƒ¨çŠ¶æ€æ  -->
{% if status == 'BLOCKED' %}
<div class="alert alert-danger d-flex align-items-center">
    <i class="bi bi-exclamation-octagon-fill me-2" style="font-size: 1.5rem;"></i>
    <div>
        <strong>è®¿é—®è¢«æ‹’ç» (Access Denied)</strong><br>
        {{ msg }}
    </div>
</div>
{% else %}
<div class="alert alert-success d-flex justify-content-between align-items-center">
    <span><i class="bi bi-check-circle-fill me-2"></i> {{ msg }}</span>
    <span class="badge bg-white text-success border">ç”¨æˆ·: {{ username }}</span>
</div>
{% endif %}

<div class="row">
    <!-- å·¦ä¾§ï¼šæŒ‡çº¹ä¸æ§åˆ¶ -->
    <div class="col-lg-4 mb-4">
        <!-- 1. ä»ªè¡¨ç›˜ -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title text-center text-secondary">å®æ—¶ä¿¡èª‰è¯„åˆ†</h5>
                <div id="scoreGauge" style="width: 100%; height: 250px;"></div>
            </div>
        </div>

        <!-- 2. è®¾å¤‡æŒ‡çº¹å¡ç‰‡ -->
        <div class="card mb-3">
            <div class="card-header bg-white fw-bold">
                <i class="bi bi-fingerprint text-primary"></i> è®¾å¤‡ç¯å¢ƒæ„ŸçŸ¥
            </div>
            <ul class="list-group list-group-flush small">
                <li class="list-group-item d-flex justify-content-between">
                    <span>æ“ä½œç³»ç»Ÿ</span>
                    <span class="fw-bold">{{ device.os }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>æµè§ˆå™¨</span>
                    <span class="fw-bold">{{ device.browser }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>IP åœ°å€</span>
                    <span class="font-monospace">{{ device.ip }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>è®¾å¤‡ç±»å‹</span>
                    <span>{{ device.type }}</span>
                </li>
            </ul>
            <div class="card-footer bg-light text-muted" style="font-size: 10px;">
                User-Agent: {{ device.ua_raw }}
            </div>
        </div>

        <!-- 3. æ”»å‡»æ¨¡æ‹Ÿå™¨ -->
        <div class="card">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-joystick"></i> æ”»å‡»æ¨¡æ‹Ÿæ§åˆ¶å°
            </div>
            <div class="card-body d-grid gap-2">
                <button onclick="runSimulation('risk_wifi')" class="btn btn-outline-warning btn-sm text-dark">
                    <i class="bi bi-wifi-off"></i> æ¨¡æ‹Ÿåˆ‡æ¢ä¸å®‰å…¨ Wi-Fi
                </button>
                <button onclick="runSimulation('attack_sql')" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-bug-fill"></i> æ¨¡æ‹Ÿ SQL æ³¨å…¥æ”»å‡»
                </button>
                <hr class="my-1">
                <button onclick="runSimulation('reset')" class="btn btn-success btn-sm">
                    <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®ç³»ç»ŸçŠ¶æ€
                </button>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šè¯¦æƒ…ä¸æ—¥å¿— -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5>ğŸ›¡ï¸ å®‰å…¨å®¡è®¡æ—¥å¿—æµ</h5>
            </div>
            <div class="card-body">
                {% if logs %}
                    <div class="list-group">
                        {% for log in logs %}
                        <div class="list-group-item list-group-item-action list-group-item-danger">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><i class="bi bi-shield-x"></i> é£é™©è­¦å‘Š</h6>
                            </div>
                            <p class="mb-1 small">{{ log }}</p>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-shield-check" style="font-size: 4rem; color: #d1e7dd;"></i>
                        <p class="mt-3">å½“å‰ä¼šè¯å¥åº·<br>æœªæ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º</p>
                    </div>
                {% endif %}

                <!-- ç­–ç•¥è¯´æ˜å›¾ä¾‹ -->
                <div class="mt-5 p-3 bg-light rounded border">
                    <p class="mb-2 fw-bold small text-secondary">åŠ¨æ€è®¿é—®æ§åˆ¶ç­–ç•¥ (ABAC):</p>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 50%">æ‹¦æˆª (&lt;50)</div>
                        <div class="progress-bar bg-warning text-dark" role="progressbar" style="width: 30%">MFA (50-80)</div>
                        <div class="progress-bar bg-success" role="progressbar" style="width: 20%">å…è®¸ (&gt;80)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–ä»ªè¡¨ç›˜
    var myChart = echarts.init(document.getElementById('scoreGauge'));
    var option = {
        series: [{
            type: 'gauge',
            min: 0, max: 100,
            splitNumber: 5,
            itemStyle: { color: '#58D9F9' },
            progress: { show: true, width: 18 },
            pointer: { icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z', length: '12%', width: 10, offsetCenter: [0, '-60%'], itemStyle: { color: 'auto' } },
            axisLine: { lineStyle: { width: 18, color: [[0.5, '#dc3545'], [0.8, '#ffc107'], [1, '#198754']] } },
            axisTick: { distance: -18, length: 8, lineStyle: { color: '#fff', width: 2 } },
            splitLine: { distance: -18, length: 30, lineStyle: { color: '#fff', width: 4 } },
            axisLabel: { color: 'inherit', distance: 25, fontSize: 12 },
            detail: { valueAnimation: true, formatter: '{value} åˆ†', color: 'inherit', fontSize: 24 },
            data: [{ value: {{ score }} }]
        }]
    };
    myChart.setOption(option);
</script>
{% endblock %}